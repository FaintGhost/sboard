services:
  panel:
    build:
      context: ../panel
      dockerfile: Dockerfile
    environment:
      PANEL_JWT_SECRET: "e2e-test-jwt-secret-key-32chars!!"
      PANEL_SETUP_TOKEN: "e2e-test-setup-token"
      PANEL_DB_PATH: "/data/panel.db"
      PANEL_SERVE_WEB: "true"
      PANEL_WEB_DIR: "/app/web/dist"
      PANEL_LOG_REQUESTS: "true"
      PANEL_NODE_MONITOR_INTERVAL: "5s"
      PANEL_TRAFFIC_MONITOR_INTERVAL: "10s"
    volumes:
      - panel-data:/data
    networks:
      - e2e-net

  node:
    build:
      context: ../node
      dockerfile: Dockerfile
    environment:
      NODE_SECRET_KEY: "e2e-test-node-secret"
      NODE_LOG_LEVEL: "debug"
    volumes:
      - node-data:/data
    networks:
      - e2e-net

  probe:
    image: hashicorp/http-echo:1.0.0
    command: ["-text=ok", "-listen=:8080"]
    networks:
      - e2e-net

  sb-client:
    image: gzxhwq/sing-box:1.12.19
    restart: always
    command: ["run", "-D", "/etc/sing-box", "-C", "/etc/sing-box"]
    volumes:
      - sb-shared:/etc/sing-box
    networks:
      - e2e-net

  playwright:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      CI: "true"
      BASE_URL: "http://panel:8080"
      NODE_API_URL: "http://node:3000"
      NODE_SECRET_KEY: "e2e-test-node-secret"
      SETUP_TOKEN: "e2e-test-setup-token"
      PROBE_URL: "http://probe:8080"
      SB_CLIENT_SOCKS5: "sb-client:10801"
      SB_CLIENT_CONFIG_DIR: "/shared"
    volumes:
      - ./playwright-report:/app/playwright-report
      - ./test-results:/app/test-results
      - sb-shared:/shared
    depends_on:
      - panel
      - node
      - probe
      - sb-client
    ipc: host
    networks:
      - e2e-net

volumes:
  panel-data:
  node-data:
  sb-shared:

networks:
  e2e-net:
    driver: bridge
